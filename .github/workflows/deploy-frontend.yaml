# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Frontend → ACR → WebApp

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  BUILD_CONTEXT: ./frontend   # <-- renamed from DOCKER_CONTEXT
  IMAGE_NAME: microtodoui
  CONTAINER_PORT: 80

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify build context exists
        run: |
          ls -la $BUILD_CONTEXT || (echo "Path not found: $BUILD_CONTEXT" && exit 1)
          test -f "$BUILD_CONTEXT/Dockerfile" || (echo "Dockerfile not found in $BUILD_CONTEXT" && exit 1)

      - name: Azure Login using Azure Credentials
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: ACR login
        run: az acr login --name ${{ secrets.ACR_NAME }}

      - name: Build & Push (ACR)
        uses: docker/build-push-action@v4
        with:
          context: ${{ env.BUILD_CONTEXT }}            # <-- use BUILD_CONTEXT here
          file: ${{ env.BUILD_CONTEXT }}/Dockerfile    # explicit Dockerfile path (optional but clear)
          push: true
          tags: |
            ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
            ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:main
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Ensure WebApp managed identity has AcrPull
        shell: bash
        run: |
          set -e
          az webapp identity assign -g "${{ secrets.RESOURCE_GROUP }}" -n "${{ secrets.WEBAPP_NAME }}" >/dev/null
          PRINCIPAL_ID=$(az webapp identity show -g "${{ secrets.RESOURCE_GROUP }}" -n "${{ secrets.WEBAPP_NAME }}" --query principalId -o tsv)
          ACR_ID=$(az acr show -n "${{ secrets.ACR_NAME }}" --query id -o tsv)
          az role assignment create --assignee "$PRINCIPAL_ID" --role AcrPull --scope "$ACR_ID" >/dev/null || true

      - name: Deploy container to Web App
        shell: bash
        run: |
          set -e
          az webapp config container set \
            -g "${{ secrets.RESOURCE_GROUP }}" \
            -n "${{ secrets.WEBAPP_NAME }}" \
            --docker-custom-image-name "${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}" \
            --docker-registry-server-url "https://${{ secrets.ACR_LOGIN_SERVER }}"

          az webapp config appsettings set \
            -g "${{ secrets.RESOURCE_GROUP }}" \
            -n "${{ secrets.WEBAPP_NAME }}" \
            --settings WEBSITES_PORT="${{ env.CONTAINER_PORT }}"

          if [ -n "${{ secrets.BACKEND_URL }}" ]; then
            az webapp config appsettings set \
              -g "${{ secrets.RESOURCE_GROUP }}" \
              -n "${{ secrets.WEBAPP_NAME }}" \
              --settings BACKEND_URL="${{ secrets.BACKEND_URL }}"
          fi

      - name: Restart Web App
        run: az webapp restart -g "${{ secrets.RESOURCE_GROUP }}" -n "${{ secrets.WEBAPP_NAME }}"

      - name: Show WebApp URL
        run: az webapp show -g "${{ secrets.RESOURCE_GROUP }}" -n "${{ secrets.WEBAPP_NAME }}" --query defaultHostName -o tsv

